
var shiftHeld=false;var body;var loader;var dialog_max_width=712;var buttonSelector="button, [type='button'], [type='submit'], [type='reset'], [type='image']";var inputSelector="select, input, textarea";var notInputSelector="[type='radio'], [type='checkbox'], [type='button'], [type='submit'], [type='reset'], [type='image'], [type='hidden']";var checkboxradioSelector="[type='radio'], [type='checkbox']";$(document).ready(function(){$.extend($.support,{touch:"ontouchend"in document});flash_notice();init_interface();init_modal_dialogs();init_nested_form_links();$.rails.allowAction=function(element){var message=element.data('confirm'),answer=false,callback;if(!message){return true;}
if($.rails.fire(element,'confirm')){confirmBox(message,function(){callback=$.rails.fire(element,'confirm:complete',[answer]);if(callback){var oldAllowAction=$.rails.allowAction;$.rails.allowAction=function(){return true;};element.trigger('click');$.rails.allowAction=oldAllowAction;}});}
return false;}
function confirmBox(message,callback){c=$('#page-confirm-dialog');c.find('#confirm-dialog-true').bind("click",function(e){$('#confirm-dialog-false').unbind('click');$(this).unbind('click');c.dialog('close');callback.call();});c.find('#confirm-dialog-false').bind("click",function(e){$('#confirm-dialog-true').unbind('click');$(this).unbind('click');c.dialog('close');});c.find('#confirm-dialog-message').html(message);c.dialog({dialogClass:'danger',modal:true,resizable:false,draggable:false,width:480});}
$("a[data-remote]").bind("ajax:beforeSend",function(event,xhr){$.gecko.attachLoading()}).bind("ajax:complete",function(event,xhr,status){$.gecko.removeLoading("body")});});var link_tester={initialised:false,init:function(test_url,test_email){this.test_url=test_url;this.test_email=test_email;this.initialised=true;},email:function(value,callback){$.getJSON(link_tester.test_email,{email:value},function(data){callback(data.result=='success');});},url:function(value,callback){$.getJSON(link_tester.test_url,{'url':value},function(data){callback(data.result=='success');});},validate_textbox:function(validation_method,textbox_id,callback){var icon='';var loader_img=$("<img id='"+textbox_id.replace('#','')+"_test_loader' src='/images/gko-core/ajax-loader.gif' alt='Testing...' style='display: none;'/>");var result_span=$("<span id='"+textbox_id.replace('#','')+"_test_result'></span>");loader_img.insertAfter($(textbox_id));result_span.insertAfter(loader_img);$(textbox_id).bind('paste blur',function(){$(textbox_id).stop(true);$(textbox_id+'_test_loader').hide();$(textbox_id+'_test_result').hide();$(textbox_id+'_test_result').removeClass('success_icon').removeClass('failure_icon');$(textbox_id).delay(300).queue(function(){$(textbox_id+'_test_loader').show();$(textbox_id+'_test_result').hide();$(textbox_id+'_test_result').removeClass('success_icon').removeClass('failure_icon');validation_method(this.value,function(success){if(success){icon='success_icon';}else{icon='failure_icon';}
$(textbox_id+'_test_result').addClass(icon).show();$(textbox_id+'_test_loader').hide();});if(callback){callback($(textbox_id));}
$(this).dequeue();});});},validate_url_textbox:function(textbox_id,callback){link_tester.validate_textbox(link_tester.url,textbox_id,callback);},validate_email_textbox:function(textbox_id,callback){link_tester.validate_textbox(link_tester.email,textbox_id,callback);}};var images_dialog={initialised:false,init:function(){if(!this.initialised){$('#image_dialog_size_container ul li a').click(function(e){$('#image_dialog_size_container ul li').removeClass('selected');$(this).parent().addClass('selected');e.preventDefault();});$('body#dialog_container ul.images a').live("click",function(e){e.preventDefault();var link=$(this),form=$("#image_assignments_form");if(form.length>0){var dom_id=link.closest("li").attr('id');var id=$.gecko.parseValue(dom_id);$('#image_assignment_image_id').val(id);form.live("ajax:beforeSend.rails",function(xhr,settings){$.gecko.attachLoading("body#dialog_container");}).live("ajax:complete.rails",function(xhr,status){$.gecko.removeLoading("body#dialog_container");}).submit();}else{var img=link.find('img:first');var size=$('#image_dialog_size_container li.selected a').attr('data-size');image_url=img.attr('data-'+size);if(parent){if((wym_src=parent.document.getElementById('wym_src'))!=null){wym_src.value=image_url;}
if((wym_title=parent.document.getElementById('wym_title'))!=null){wym_title.value=img.attr('title');}
if((wym_alt=parent.document.getElementById('wym_alt'))!=null){wym_alt.value=img.attr('alt');}
if((wym_dialog_submit=parent.document.getElementById('wym_dialog_submit'))!=null){wym_dialog_submit.click();}}}});this.initialised=true;}},}
var link_dialog={initialised:false,init:function(){if(!this.initialised){this.init_close();this.page_tab();this.web_tab();this.email_tab();this.initialised=true;}},init_close:function(){if(parent&&parent.document.location.href!=document.location.href&&parent.document.getElementById('wym_dialog_submit')!=null){$('#dialog_container input#insert_link_submit').click(function(e){e.preventDefault();$(parent.document.getElementById('wym_dialog_submit')).click();});}},page_tab:function(){$('#link_to_page li a').click(function(e){e.preventDefault();link_dialog.update_parent($(this).attr("href"));});},web_tab:function(){$('#web_address_text').change(function(e){link_dialog.update_parent($('#web_address_text').val(),null,"_blank");});},email_tab:function(){$('#email_address_text, #email_default_subject_text, #email_default_body_text').change(function(e){var default_subject=$('#email_default_subject_text').val(),default_body=$('#email_default_body_text').val(),mailto="mailto:"+$('#email_address_text').val(),modifier="?";if(default_subject.length>0){mailto+=modifier+"subject="+default_subject;modifier="&";}
if(default_body.length>0){mailto+=modifier+"body="+default_body;modifier="&";}
link_dialog.update_parent(mailto,mailto.replace('mailto:',''));});},update_parent:function(url,title,target){if(parent!=null){if((wym_href=parent.document.getElementById('wym_href'))!=null){wym_href.value=url;}
if((wym_title=parent.document.getElementById('wym_title'))!=null){wym_title.value=title;}
if((wym_target=parent.document.getElementById('wym_target'))!=null){wym_target.value=target||"";}}}};close_dialog=function(e){if(parent&&parent.document.location.href!=document.location.href&&$.isFunction(parent.$)){$(parent.document.body).removeClass('hide-overflow');parent.$('.ui-dialog').dialog('close').remove();}else{$(document.body).removeClass('hide-overflow');$('.ui-dialog').dialog('close').remove();}
e.preventDefault();}
init_interface=function(){$.extend($.ui.dialog,{center:function($el){this.center_screen}});$(window).bind("resize",function(e){$('.ui-dialog').each(function(){$.gecko.centerDialog($(this));})});$('a[data-role="button"]').not(".ui-btn").buttonMarkup();$(buttonSelector).button().bind('click',function(e){$(this).closest('form').submit();e.preventDefault();});$('div[data-role="navbar"]').navbar();$('#super-admin-menu-btn').live('click',function(e){e.preventDefault();$('#super-admin-menu').toggle('fast');})
$(checkboxradioSelector).checkboxradio();$(inputSelector).not(notInputSelector).textinput();$('select[data-role="slider"]').slidee();$('select:not([data-role="slider"])').selectlist();$('fieldset[data-role="controlgroup"], div[data-role="controlgroup"]').controlgroup();$('input:[type="text"].date, input:[type="text"].datetime').datepicker();if(!$.support.touch){$('.tooltip').tooltip();}
$("div[data-role='collapsible']").collapsible({collapsed:true});$('#dialog_container .tabs-contain').tabs();$("a[data-rel='dialog']").not('.danger').bind('click',function(e){e.preventDefault();$anchor=$(this);var size=$anchor.data('dialog-size'),title=$anchor.data('dialog-title')||"Dialog",target=$($anchor.attr('href'));var screenSize=$.gecko.getScreenSize();if(size){if(size=="fullscreen"){width=screenSize.width;height=screenSize.height;}
else if(match=size.match(/^(.+?)\s+(is(?:\sx)?)\s+(.+)$/)){width=Math.min(screenSize.width,match[1]);height=Math.min(screenSize.height,match[2]);}}
else{width=Math.min(screenSize.width,target.outerWidth());height=Math.min(screenSize.height,target.outerHeight()+60);}
if(!width||width==0){width=Math.min(screenSize.width,500);}
if(!height||height==0){height=Math.min(screenSize.height,400);}
log("width "+width+" "+"height "+height+" ")
target.dialog({'title':title,'width':width,'height':height});$anchor.trigger('open_dialog');});$('textarea.wymeditor').each(function(){textarea=$(this);if((instance=WYMeditor.INSTANCES[$((textarea.next('.wym_box').find('iframe').attr('id')||'').split('_')).last().get(0)])!=null){if((next=textarea.parent().next())!=null&&next.length>0){next.find('input, textarea').keydown($.proxy(function(e){shiftHeld=e.shiftKey;if(shiftHeld&&e.keyCode==$.ui.keyCode.TAB){this._iframe.contentWindow.focus();e.preventDefault();}},instance)).keyup(function(e){shiftHeld=false;});}
if((prev=textarea.parent().prev())!=null&&prev.length>0){prev.find('input, textarea').keydown($.proxy(function(e){if(e.keyCode==$.ui.keyCode.TAB){this._iframe.contentWindow.focus();e.preventDefault();}},instance));}}});}
init_nested_form_links=function(){$('form a.add-nested-field').live('click',function(e){e.preventDefault();var link=$(this),target=$(link.attr('href')),new_id=$.gecko.timestamp(),assoc=link.data('association'),content=link.data('template'),regexp=new RegExp("new_"+assoc,"g"),new_content=content.replace(regexp,new_id);$(new_content).appendTo(target).attr('id',new_id).addClass('dynamic');var f=$("#"+new_id);f.find('a.remove-nested-field, a.add-nested-field').each(function(i,el){$(el).attr('href',"#"+new_id);})
f.find('input:[type="text"].date').each(function(i,el){$(el).datepicker();});f.find("select, input, textarea").each(function(i,el){$(el).textinput();});});$('form a.remove-nested-field').live('click',function(e){var link=$(this),target=$(link.attr('href'));if(target.length){if(link.hasClass('dynamic')){target.fadeOut(500).remove();link.siblings("input[type='hidden']").val('1');link.siblings("form").trigger('nested:fieldRemoved');}else{target.fadeOut(500);link.siblings("input[type='hidden']").val('1');link.siblings("form").trigger('nested:fieldRemoved');}}
e.preventDefault();});}
init_modal_dialogs=function(){$('a[href*="dialog=true"]').not('#dialog_container a').each(function(i,anchor){$(anchor).click(function(e){$anchor=$(this);iframe_src=(iframe_src=$anchor.attr('href'))
+(iframe_src.indexOf('?')>-1?'&':'?')
+'app_dialog=true&dialog=true';iframe=$("<iframe id='dialog_iframe' frameborder='0' marginheight='0' marginwidth='0' border='0'></iframe>");iframe.dialog({title:$anchor.data('dialog-title'),modal:true,resizable:false,draggable:false,position:"center",autoOpen:true,width:$anchor.data('dialog-width')||dialog_max_width,height:$anchor.data('dialog-height')||($(window).height()-100),open:onOpenDialog,close:onCloseDialog});iframe.attr('src',iframe_src);e.preventDefault();});});};flash_notice=function(){$("#flash .flash").each(function(){jQuery.noticeAdd({type:$(this).data('type'),stay:false,text:$(this).html()});$(this).remove();})};selectable_list=function(){$.fn.selectAllRows=function(callerSettings){var settings;var headerCheckbox;var columnCheckboxes;settings=$.extend({column:'first',selectTip:'Click to Select All',unselectTip:'Click to Un-Select All'},callerSettings||{});if(isNaN(settings.column)){headerCheckbox=$("thead tr th:"+settings.column+"-child input:checkbox",this);columnCheckboxes=$("tbody tr td:"+settings.column+"-child input:checkbox",this);}
else{headerCheckbox=$("thead tr th:nth-child("+settings.column+") input:checkbox",this);columnCheckboxes=$("tbody tr td:nth-child("+settings.column+") input:checkbox",this);}
headerCheckbox.attr("title",settings.selectTip);headerCheckbox.click(function(){var checkedStatus=this.checked;columnCheckboxes.each(function(){this.checked=checkedStatus;});if(checkedStatus==true){$(this).attr("title",settings.unselectTip);}
else{$(this).attr("title",settings.selectTip);}});return $(this);};}
make_sortable=function(element,url,axis){element.sortable({axis:axis,dropOnEmpty:false,cursor:'drag',items:'li',connectWith:'.nested',update:function(event,ui){item=$(ui.item);$.ajax({type:"GET",url:url,data:{position:item.prevAll().length+1,id:$.gecko.parseValue(item.attr('id'))},beforeSend:function(xhr){$.gecko.attachLoading();},complete:function(xhr,status){$.gecko.removeLoading();}});}})
element.disableSelection();}
make_list_toggable=function(ul){ul.children('li').each(function(){make_element_toggable($(this))});}
make_element_toggable=function(element){var actions=element.find(".actions:first");actions.fadeOut(100);element.hover(function(){actions.fadeIn(100);},function(){actions.fadeOut(500);});}
parseURL=function(url){var loc={'href':url};var parts=url.replace('//','/').split('/');loc.protocol=parts[0];loc.host=parts[1];parts[1]=parts[1].split(':');loc.hostname=parts[1][0];loc.port=parts[1].length>1?parts[1][1]:'';parts.splice(0,2);loc.pathname='/'+parts.join('/');loc.pathname=loc.pathname.split('#');loc.hash=loc.pathname.length>1?'#'+loc.pathname[1]:'';loc.pathname=loc.pathname[0];loc.pathname=loc.pathname.split('?');loc.search=loc.pathname.length>1?'?'+loc.pathname[1]:'';loc.pathname=loc.pathname[0];return loc;}
iframed=function(){return(parent&&parent.document.location.href!=document.location.href&&$.isFunction(parent.$));};